<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ANON EDU - Learn Anonymously</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        :root {
            --primary: #1e40af;
            --primary-light: #3b82f6;
            --secondary: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --light: #f8fafc;
            --dark: #1e293b;
            --gray: #64748b;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --radius: 12px;
        }
        
        body {
            background-color: #f1f5f9;
            color: var(--dark);
            line-height: 1.6;
        }
        
        /* Login Page */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
            padding: 20px;
        }
        
        .login-box {
            background: white;
            border-radius: var(--radius);
            padding: 40px;
            width: 100%;
            max-width: 450px;
            box-shadow: var(--shadow);
            text-align: center;
        }
        
        .logo {
            font-size: 2.5rem;
            color: var(--primary);
            margin-bottom: 10px;
        }
        
        .login-box h1 {
            color: var(--dark);
            margin-bottom: 10px;
        }
        
        .login-box p {
            color: var(--gray);
            margin-bottom: 30px;
        }
        
        .login-btn {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1rem;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            width: 100%;
            transition: all 0.3s;
            font-weight: 600;
        }
        
        .login-btn:hover {
            background-color: var(--primary-light);
            transform: translateY(-2px);
        }
        
        .login-status {
            margin-top: 20px;
            padding: 12px;
            border-radius: 8px;
            font-size: 0.9rem;
        }
        
        .login-status.success {
            background-color: #d1fae5;
            color: #065f46;
        }
        
        .login-status.error {
            background-color: #fee2e2;
            color: #991b1b;
        }
        
        /* App Container */
        .hidden {
            display: none !important;
        }
        
        .app-container {
            min-height: 100vh;
        }
        
        /* Header */
        header {
            background: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 18px 5%;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .app-logo {
            font-size: 1.8rem;
            color: var(--primary);
            font-weight: 700;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--primary-light);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .logout-btn {
            background: none;
            border: 1px solid var(--gray);
            color: var(--gray);
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .logout-btn:hover {
            background-color: var(--danger);
            color: white;
            border-color: var(--danger);
        }
        
        .admin-badge {
            background: var(--warning);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        /* Profile Setup Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }
        
        .modal-content {
            background: white;
            border-radius: var(--radius);
            padding: 40px;
            width: 100%;
            max-width: 500px;
            box-shadow: var(--shadow);
        }
        
        .modal-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .modal-header i {
            font-size: 2rem;
            color: var(--primary);
        }
        
        .modal-header h2 {
            color: var(--dark);
        }
        
        /* Main Content */
        .main-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px 5%;
        }
        
        .section-title {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 25px;
            color: var(--dark);
        }
        
        .section-title i {
            color: var(--primary);
        }
        
        /* Dashboard Stats */
        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .stat-card {
            background: white;
            border-radius: var(--radius);
            padding: 25px;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
        }
        
        .stat-icon.courses {
            background-color: #e0f2fe;
            color: #0369a1;
        }
        
        .stat-icon.admin {
            background-color: #dcfce7;
            color: #166534;
        }
        
        .stat-info h3 {
            font-size: 2rem;
            margin-bottom: 5px;
        }
        
        .stat-info p {
            color: var(--gray);
            font-size: 0.9rem;
        }
        
        /* Courses Grid */
        .courses-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }
        
        .course-card {
            background: white;
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow);
            transition: transform 0.3s;
        }
        
        .course-card:hover {
            transform: translateY(-5px);
        }
        
        .course-image {
            height: 160px;
            background: linear-gradient(to right, #1e40af, #3b82f6);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 3rem;
        }
        
        .course-content {
            padding: 25px;
        }
        
        .course-title {
            font-size: 1.3rem;
            margin-bottom: 10px;
            color: var(--dark);
        }
        
        .course-description {
            color: var(--gray);
            margin-bottom: 20px;
            font-size: 0.95rem;
        }
        
        .course-meta {
            display: flex;
            justify-content: space-between;
            color: var(--gray);
            font-size: 0.85rem;
            margin-bottom: 20px;
        }
        
        .enroll-btn {
            background-color: var(--primary);
            color: white;
            border: none;
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s;
        }
        
        .enroll-btn:hover {
            background-color: var(--primary-light);
        }
        
        .enroll-btn:disabled {
            background-color: var(--secondary);
            cursor: not-allowed;
        }
        
        /* Admin Panel */
        .admin-panel {
            background: white;
            border-radius: var(--radius);
            padding: 30px;
            box-shadow: var(--shadow);
            margin-top: 30px;
        }
        
        .admin-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 25px;
        }
        
        .admin-title {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--dark);
        }
        
        .admin-title i {
            color: var(--warning);
        }
        
        .toggle-admin {
            background: var(--warning);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        textarea.form-control {
            min-height: 120px;
            resize: vertical;
        }
        
        .btn-primary {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: background-color 0.3s;
        }
        
        .btn-primary:hover {
            background-color: var(--primary-light);
        }
        
        .btn-danger {
            background-color: var(--danger);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s;
        }
        
        .btn-danger:hover {
            background-color: #dc2626;
        }
        
        /* Admin Course List */
        .admin-course-list {
            margin-top: 30px;
        }
        
        .admin-course-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: #f8fafc;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid var(--primary);
        }
        
        .admin-course-info h4 {
            margin-bottom: 5px;
        }
        
        .admin-course-info p {
            color: var(--gray);
            font-size: 0.9rem;
        }
        
        /* Students List with Details */
        .students-list {
            margin-top: 40px;
        }
        
        .students-table {
            background: white;
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow);
        }
        
        .table-header {
            display: grid;
            grid-template-columns: 1fr 2fr 2fr 1fr 1fr 1fr;
            background: var(--primary);
            color: white;
            padding: 15px 20px;
            font-weight: 600;
        }
        
        .table-row {
            display: grid;
            grid-template-columns: 1fr 2fr 2fr 1fr 1fr 1fr;
            padding: 15px 20px;
            border-bottom: 1px solid #e5e7eb;
            align-items: center;
        }
        
        .table-row:nth-child(even) {
            background: #f9fafb;
        }
        
        .enrolled-courses-count {
            background: var(--primary-light);
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            text-align: center;
            display: inline-block;
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 2px solid #e5e7eb;
            margin-bottom: 30px;
        }
        
        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 600;
            color: var(--gray);
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }
        
        .tab.active {
            color: var(--primary);
            border-bottom: 2px solid var(--primary);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Course Subjects & Chapters */
        .subjects-container, .chapters-container {
            margin-top: 30px;
        }
        
        .subject-card, .chapter-card {
            background: white;
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: var(--shadow);
        }
        
        .subject-header, .chapter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .chapter-files {
            margin-top: 15px;
        }
        
        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: #f8fafc;
            border-radius: 8px;
            margin-bottom: 8px;
        }
        
        .file-type-badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .vod-badge {
            background: #e0f2fe;
            color: #0369a1;
        }
        
        .notes-badge {
            background: #dcfce7;
            color: #166534;
        }
        
        .mcqs-badge {
            background: #fef3c7;
            color: #92400e;
        }
        
        .file-actions {
            display: flex;
            gap: 10px;
        }
        
        /* Upload Form */
        .upload-form {
            background: #f8fafc;
            padding: 20px;
            border-radius: var(--radius);
            margin-top: 15px;
        }
        
        .upload-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .file-type-select {
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background: white;
        }
        
        /* Student Course View */
        .student-course-content {
            background: white;
            border-radius: var(--radius);
            padding: 30px;
            box-shadow: var(--shadow);
        }
        
        .back-btn {
            background: var(--gray);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 20px;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .dashboard-stats {
                grid-template-columns: 1fr;
            }
            
            .courses-grid {
                grid-template-columns: 1fr;
            }
            
            .header-content {
                flex-direction: column;
                gap: 15px;
            }
            
            .table-header, .table-row {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .admin-header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
            
            .toggle-admin {
                width: 100%;
            }
            
            .upload-controls {
                flex-direction: column;
            }
        }
        
        /* Student Enrolled Courses */
        .enrolled-courses {
            margin-top: 40px;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }
        
        .empty-state i {
            font-size: 4rem;
            color: var(--gray);
            margin-bottom: 20px;
        }
        
        .empty-state h3 {
            color: var(--dark);
            margin-bottom: 10px;
        }
        
        .empty-state p {
            color: var(--gray);
            max-width: 500px;
            margin: 0 auto;
        }
        
        /* Profile Form */
        .profile-form {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="loginContainer" class="login-container">
        <div class="login-box">
            <div class="logo">
                <i class="fas fa-graduation-cap"></i>
            </div>
            <h1>Welcome to ANON EDU</h1>
            <p>Learn anonymously with quality courses. Sign in to continue.</p>
            
            <button id="loginBtn" class="login-btn">
                <i class="fab fa-google"></i>
                Sign in with Google
            </button>
            
            <div id="loginStatus" class="login-status"></div>
        </div>
    </div>
    
    <!-- Student Profile Setup Modal -->
    <div id="profileSetupModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <i class="fas fa-user-edit"></i>
                <h2>Complete Your Profile</h2>
            </div>
            <p style="color: var(--gray); margin-bottom: 25px;">Please provide your details to continue. This information will be saved in your profile.</p>
            
            <form id="profileForm" class="profile-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="fullName">Full Name *</label>
                        <input type="text" id="fullName" class="form-control" placeholder="Enter your full name" required>
                    </div>
                    <div class="form-group">
                        <label for="phone">Phone Number *</label>
                        <input type="tel" id="phone" class="form-control" placeholder="Enter your phone number" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="dob">Date of Birth *</label>
                        <input type="date" id="dob" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="gender">Gender *</label>
                        <select id="gender" class="form-control" required>
                            <option value="">Select Gender</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                            <option value="Other">Other</option>
                            <option value="Prefer not to say">Prefer not to say</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="address">Address *</label>
                    <textarea id="address" class="form-control" placeholder="Enter your complete address" required></textarea>
                </div>
                
                <div class="form-group">
                    <label for="education">Education Level *</label>
                    <select id="education" class="form-control" required>
                        <option value="">Select Education Level</option>
                        <option value="High School">High School</option>
                        <option value="Undergraduate">Undergraduate</option>
                        <option value="Graduate">Graduate</option>
                        <option value="Post Graduate">Post Graduate</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                
                <button type="submit" class="btn-primary">
                    <i class="fas fa-save"></i> Save Profile & Continue
                </button>
            </form>
        </div>
    </div>
    
    <!-- Main App -->
    <div id="appContainer" class="app-container hidden">
        <!-- Header -->
        <header>
            <div class="header-content">
                <div class="header-left">
                    <div class="app-logo">
                        <i class="fas fa-graduation-cap"></i> ANON EDU
                    </div>
                    <div id="adminBadge" class="admin-badge hidden">
                        <i class="fas fa-crown"></i> ADMIN
                    </div>
                </div>
                
                <div class="user-info">
                    <div id="userAvatar" class="user-avatar">U</div>
                    <div>
                        <div id="userName">User</div>
                        <div id="userEmail" style="font-size: 0.8rem; color: var(--gray);">user@example.com</div>
                    </div>
                    <button id="logoutBtn" class="logout-btn">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </div>
        </header>
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Dashboard Stats -->
            <div class="dashboard-stats">
                <div class="stat-card">
                    <div class="stat-icon courses">
                        <i class="fas fa-book-open"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="totalCourses">0</h3>
                        <p>Available Courses</p>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon admin">
                        <i class="fas fa-crown"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="adminStatus">Student</h3>
                        <p>Your Role</p>
                    </div>
                </div>
            </div>
            
            <!-- Student View: Available Courses -->
            <div id="studentView">
                <!-- Student's Course Details View (Hidden by default) -->
                <div id="studentCourseDetailView" class="hidden">
                    <button id="backToCoursesBtn" class="back-btn">
                        <i class="fas fa-arrow-left"></i> Back to Courses
                    </button>
                    <div id="studentCourseContent" class="student-course-content">
                        <!-- Course details will be loaded here -->
                    </div>
                </div>
                
                <!-- Student's Course List View -->
                <div id="studentCourseListView">
                    <div class="section-title">
                        <i class="fas fa-book"></i>
                        <h2>Available Courses</h2>
                    </div>
                    
                    <div id="coursesContainer" class="courses-grid">
                        <!-- Courses will be loaded here -->
                    </div>
                    
                    <!-- Student Enrolled Courses -->
                    <div class="enrolled-courses">
                        <div class="section-title">
                            <i class="fas fa-check-circle"></i>
                            <h2>Your Enrolled Courses</h2>
                        </div>
                        
                        <div id="enrolledCoursesContainer" class="courses-grid">
                            <!-- Enrolled courses will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Admin Panel (Hidden by default) -->
            <div id="adminPanel" class="hidden">
                <!-- Admin Tabs -->
                <div class="tabs">
                    <button class="tab active" data-tab="courses">Manage Courses</button>
                    <button class="tab" data-tab="students">Students List</button>
                </div>
                
                <!-- Courses Tab -->
                <div id="coursesTab" class="tab-content active">
                    <div class="admin-panel">
                        <div class="admin-header">
                            <div class="admin-title">
                                <i class="fas fa-book"></i>
                                <h2>Manage Courses</h2>
                            </div>
                            <button id="toggleStudentView" class="toggle-admin">
                                <i class="fas fa-eye"></i> View Student Dashboard
                            </button>
                        </div>
                        
                        <!-- Create Course Form -->
                        <h3 style="margin-bottom: 20px;">Create New Course</h3>
                        <form id="createCourseForm">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="courseTitle">Course Title *</label>
                                    <input type="text" id="courseTitle" class="form-control" placeholder="e.g., Introduction to Web Development" required>
                                </div>
                                <div class="form-group">
                                    <label for="courseDuration">Duration (weeks)</label>
                                    <input type="number" id="courseDuration" class="form-control" placeholder="8" min="1" max="52">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="courseDescription">Course Description *</label>
                                <textarea id="courseDescription" class="form-control" placeholder="Describe what students will learn in this course..." required></textarea>
                            </div>
                            
                            <button type="submit" class="btn-primary">
                                <i class="fas fa-plus-circle"></i> Create Course
                            </button>
                        </form>
                        
                        <!-- Manage Course Subjects & Chapters -->
                        <div id="courseManageView" class="hidden">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin: 30px 0 20px 0;">
                                <h3 id="courseManageTitle">Course: Loading...</h3>
                                <button id="backToCourseListBtn" class="btn-primary" style="padding: 8px 16px;">
                                    <i class="fas fa-arrow-left"></i> Back to Courses
                                </button>
                            </div>
                            
                            <!-- Add Subject Form -->
                            <div class="upload-form">
                                <h4 style="margin-bottom: 15px;">Add New Subject</h4>
                                <div class="form-row">
                                    <div class="form-group">
                                        <input type="text" id="subjectName" class="form-control" placeholder="Enter subject name">
                                    </div>
                                    <div class="form-group">
                                        <button id="addSubjectBtn" class="btn-primary">
                                            <i class="fas fa-plus"></i> Add Subject
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Subjects List -->
                            <div id="subjectsContainer" class="subjects-container">
                                <!-- Subjects will be loaded here -->
                            </div>
                        </div>
                        
                        <!-- Admin Course List -->
                        <div id="adminCourseListView">
                            <h3 style="margin: 30px 0 20px 0;">Existing Courses</h3>
                            <div id="adminCoursesContainer">
                                <!-- Admin courses will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Students Tab -->
                <div id="studentsTab" class="tab-content">
                    <div class="admin-panel">
                        <div class="admin-header">
                            <div class="admin-title">
                                <i class="fas fa-users"></i>
                                <h2>Students List</h2>
                            </div>
                            <button id="refreshStudentsBtn" class="btn-primary" style="padding: 8px 16px;">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                        
                        <div class="students-list">
                            <div id="studentsTable" class="students-table">
                                <!-- Students will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import {
            getAuth,
            GoogleAuthProvider,
            signInWithPopup,
            onAuthStateChanged,
            signOut
        } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import {
            getFirestore,
            collection,
            addDoc,
            getDocs,
            doc,
            getDoc,
            setDoc,
            deleteDoc,
            updateDoc,
            query,
            where,
            serverTimestamp
        } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCrYI0hoeMs2OLZO_JmYKcKJ-G6l1KPdH0",
            authDomain: "signin-cd148.firebaseapp.com",
            projectId: "signin-cd148",
            appId: "1:288075773833:web:7485c78b7f71b871035358"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        
        // Admin Email
        const ADMIN_EMAIL = "bimbadharbaghel0@gmail.com";

        // DOM Elements
        const loginContainer = document.getElementById('loginContainer');
        const appContainer = document.getElementById('appContainer');
        const profileSetupModal = document.getElementById('profileSetupModal');
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const loginStatus = document.getElementById('loginStatus');
        const profileForm = document.getElementById('profileForm');
        const userName = document.getElementById('userName');
        const userEmail = document.getElementById('userEmail');
        const userAvatar = document.getElementById('userAvatar');
        const adminBadge = document.getElementById('adminBadge');
        const adminPanel = document.getElementById('adminPanel');
        const studentView = document.getElementById('studentView');
        const studentCourseListView = document.getElementById('studentCourseListView');
        const studentCourseDetailView = document.getElementById('studentCourseDetailView');
        const studentCourseContent = document.getElementById('studentCourseContent');
        const coursesContainer = document.getElementById('coursesContainer');
        const enrolledCoursesContainer = document.getElementById('enrolledCoursesContainer');
        const adminCoursesContainer = document.getElementById('adminCoursesContainer');
        const createCourseForm = document.getElementById('createCourseForm');
        const toggleStudentView = document.getElementById('toggleStudentView');
        const totalCourses = document.getElementById('totalCourses');
        const adminStatus = document.getElementById('adminStatus');
        const studentsTable = document.getElementById('studentsTable');
        const refreshStudentsBtn = document.getElementById('refreshStudentsBtn');
        const backToCoursesBtn = document.getElementById('backToCoursesBtn');
        const courseManageView = document.getElementById('courseManageView');
        const adminCourseListView = document.getElementById('adminCourseListView');
        const backToCourseListBtn = document.getElementById('backToCourseListBtn');
        const courseManageTitle = document.getElementById('courseManageTitle');
        const subjectsContainer = document.getElementById('subjectsContainer');
        const subjectName = document.getElementById('subjectName');
        const addSubjectBtn = document.getElementById('addSubjectBtn');

        // Global variables
        let currentUserData = null;
        let currentUserId = null;
        let currentManagingCourseId = null;
        let currentViewingCourseId = null;

        // Debug Logging
        function debugLog(message, data = null) {
            console.log(`[ANON EDU] ${message}`, data || '');
        }

        // Login with Google
        loginBtn.addEventListener('click', async () => {
            try {
                loginStatus.textContent = "Signing in...";
                loginStatus.className = "login-status";
                
                const provider = new GoogleAuthProvider();
                const result = await signInWithPopup(auth, provider);
                
                loginStatus.textContent = "Login successful!";
                loginStatus.className = "login-status success";
                
            } catch (error) {
                console.error("Login error:", error);
                loginStatus.textContent = `Error: ${error.message}`;
                loginStatus.className = "login-status error";
            }
        });

        // Logout
        logoutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
                loginContainer.classList.remove('hidden');
                appContainer.classList.add('hidden');
            } catch (error) {
                console.error("Logout error:", error);
            }
        });

        // Back to courses button for student
        backToCoursesBtn?.addEventListener('click', () => {
            studentCourseDetailView.classList.add('hidden');
            studentCourseListView.classList.remove('hidden');
        });

        // Back to course list button for admin
        backToCourseListBtn?.addEventListener('click', () => {
            courseManageView.classList.add('hidden');
            adminCourseListView.classList.remove('hidden');
            loadAdminCourses();
        });

        // Tab functionality
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                tab.classList.add('active');
                const tabId = tab.getAttribute('data-tab');
                document.getElementById(`${tabId}Tab`).classList.add('active');
                
                if (tabId === 'students') {
                    loadStudentsList();
                }
            });
        });

        // Refresh students button
        refreshStudentsBtn?.addEventListener('click', () => {
            loadStudentsList();
        });

        // Toggle between admin and student view
        toggleStudentView?.addEventListener('click', () => {
            adminPanel.classList.add('hidden');
            studentView.classList.remove('hidden');
            studentCourseListView.classList.remove('hidden');
            studentCourseDetailView.classList.add('hidden');
            courseManageView.classList.add('hidden');
            adminCourseListView.classList.remove('hidden');
        });

        // Profile form submission
        profileForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const fullName = document.getElementById('fullName').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const dob = document.getElementById('dob').value;
            const gender = document.getElementById('gender').value;
            const address = document.getElementById('address').value.trim();
            const education = document.getElementById('education').value;
            
            // Validate required fields
            if (!fullName || !phone || !dob || !gender || !address || !education) {
                showNotification("Please fill in all required fields.", "error");
                return;
            }
            
            try {
                const userRef = doc(db, "users", currentUserId);
                
                await updateDoc(userRef, {
                    fullName: fullName,
                    phone: phone,
                    dob: dob,
                    gender: gender,
                    address: address,
                    education: education,
                    profileCompleted: true,
                    lastUpdated: serverTimestamp()
                });
                
                // Update current user data
                const userSnap = await getDoc(userRef);
                currentUserData = userSnap.data();
                
                // Hide modal
                profileSetupModal.classList.add('hidden');
                
                // Update UI
                userName.textContent = fullName;
                userAvatar.textContent = fullName.charAt(0).toUpperCase();
                
                showNotification("Profile saved successfully!", "success");
                
            } catch (error) {
                console.error("Error saving profile:", error);
                showNotification("Failed to save profile. Please try again.", "error");
            }
        });

        // Add Subject button
        addSubjectBtn?.addEventListener('click', async () => {
            const name = subjectName.value.trim();
            if (!name) {
                showNotification("Please enter subject name", "error");
                return;
            }
            
            if (!currentManagingCourseId) return;
            
            try {
                await addDoc(collection(db, "courses", currentManagingCourseId, "subjects"), {
                    name: name,
                    createdAt: serverTimestamp(),
                    order: 0
                });
                
                subjectName.value = "";
                loadSubjectsForAdmin(currentManagingCourseId);
                showNotification("Subject added successfully!", "success");
                
            } catch (error) {
                console.error("Error adding subject:", error);
                showNotification("Failed to add subject", "error");
            }
        });

        // Auth State Observer - WITH PROFILE SETUP
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                debugLog("User signed in:", user.email);
                
                currentUserId = user.uid;
                
                // Show app, hide login
                loginContainer.classList.add('hidden');
                appContainer.classList.remove('hidden');
                
                // Update user info in UI
                userName.textContent = user.displayName || "User";
                userEmail.textContent = user.email;
                userAvatar.textContent = user.displayName ? user.displayName.charAt(0).toUpperCase() : "U";
                
                // Check if user is admin
                const isAdminUser = user.email === ADMIN_EMAIL;
                
                // Get or create user document
                const userRef = doc(db, "users", user.uid);
                
                try {
                    const userSnap = await getDoc(userRef);
                    
                    if (!userSnap.exists()) {
                        // NEW USER: Create user document
                        debugLog("Creating new user document...");
                        
                        const userData = {
                            uid: user.uid,
                            email: user.email,
                            displayName: user.displayName || "Anonymous User",
                            fullName: "",
                            phone: "",
                            dob: "",
                            gender: "",
                            address: "",
                            education: "",
                            role: isAdminUser ? "admin" : "student",
                            enrolledCourses: [],
                            profileCompleted: false,
                            createdAt: serverTimestamp(),
                            lastLogin: serverTimestamp()
                        };
                        
                        await setDoc(userRef, userData);
                        debugLog("User document created successfully");
                        
                        // Store user data
                        currentUserData = userData;
                        
                        // Show profile setup modal for new students (not admin)
                        if (!isAdminUser) {
                            profileSetupModal.classList.remove('hidden');
                        }
                        
                    } else {
                        // EXISTING USER
                        currentUserData = userSnap.data();
                        debugLog("Existing user data:", currentUserData);
                        
                        // Update last login
                        await updateDoc(userRef, {
                            lastLogin: serverTimestamp()
                        });
                        
                        // Check if student needs to complete profile
                        if (!isAdminUser && !currentUserData.profileCompleted) {
                            profileSetupModal.classList.remove('hidden');
                        }
                    }
                    
                    // Update UI based on role
                    updateRoleUI(currentUserData.role, isAdminUser);
                    
                    // Load all courses first
                    await loadAllCourses();
                    
                    // Show appropriate view based on role
                    if (currentUserData.role === "admin") {
                        debugLog("Showing admin panel for:", user.email);
                        adminPanel.classList.remove('hidden');
                        studentView.classList.add('hidden');
                        loadAdminCourses();
                        loadTotalStats();
                    } else {
                        debugLog("Showing student view for:", user.email);
                        adminPanel.classList.add('hidden');
                        studentView.classList.remove('hidden');
                        studentCourseListView.classList.remove('hidden');
                        studentCourseDetailView.classList.add('hidden');
                        loadStudentCourses(user.uid, currentUserData.enrolledCourses || []);
                    }
                    
                } catch (error) {
                    console.error("Error in user setup:", error);
                    showNotification("Error setting up user. Please try again.", "error");
                    
                    // Fallback: Show student view if there's an error
                    adminPanel.classList.add('hidden');
                    studentView.classList.remove('hidden');
                    loadStudentCourses(user.uid, []);
                }
                
            } else {
                // User signed out
                loginContainer.classList.remove('hidden');
                appContainer.classList.add('hidden');
                currentUserData = null;
                currentUserId = null;
            }
        });

        // Update UI based on user role
        function updateRoleUI(role, isAdminUser) {
            debugLog("Updating UI with role:", role);
            
            if (role === "admin" || isAdminUser) {
                adminStatus.textContent = "Admin";
                adminBadge.classList.remove('hidden');
                adminStatus.style.color = "var(--warning)";
            } else {
                adminStatus.textContent = "Student";
                adminBadge.classList.add('hidden');
                adminStatus.style.color = "var(--dark)";
            }
        }

        // Load all courses
        async function loadAllCourses() {
            try {
                const coursesSnapshot = await getDocs(collection(db, "courses"));
                totalCourses.textContent = coursesSnapshot.size;
                debugLog(`Total courses: ${coursesSnapshot.size}`);
                return coursesSnapshot;
            } catch (error) {
                console.error("Error loading all courses:", error);
                showNotification("Error loading courses", "error");
                return null;
            }
        }

        // Load total stats
        async function loadTotalStats() {
            try {
                const usersSnapshot = await getDocs(collection(db, "users"));
                const students = usersSnapshot.docs.filter(doc => {
                    const data = doc.data();
                    return data.role === "student" || (!data.role && data.email !== ADMIN_EMAIL);
                });
                
                // Removed totalStudents from student view as requested
                // Only used in admin panel
                
            } catch (error) {
                console.error("Error loading stats:", error);
            }
        }

        // Load courses for students
        async function loadStudentCourses(userId, enrolledCourses) {
            try {
                debugLog("Loading courses for student:", userId);
                debugLog("Enrolled courses:", enrolledCourses);
                
                coursesContainer.innerHTML = "";
                enrolledCoursesContainer.innerHTML = "";
                
                const coursesSnapshot = await getDocs(collection(db, "courses"));
                
                if (coursesSnapshot.empty) {
                    coursesContainer.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-book-open"></i>
                            <h3>No Courses Available</h3>
                            <p>There are no courses available at the moment. Please check back later.</p>
                        </div>
                    `;
                    return;
                }
                
                let enrolledCoursesData = [];
                let availableCoursesData = [];
                
                coursesSnapshot.forEach((doc) => {
                    const course = { id: doc.id, ...doc.data() };
                    const isEnrolled = enrolledCourses.includes(doc.id);
                    
                    if (isEnrolled) {
                        enrolledCoursesData.push(course);
                    } else {
                        availableCoursesData.push(course);
                    }
                });
                
                debugLog(`Available courses: ${availableCoursesData.length}`);
                debugLog(`Enrolled courses: ${enrolledCoursesData.length}`);
                
                // Display available courses
                if (availableCoursesData.length === 0) {
                    coursesContainer.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-check-circle"></i>
                            <h3>All Courses Enrolled</h3>
                            <p>You have enrolled in all available courses. Great job!</p>
                        </div>
                    `;
                } else {
                    availableCoursesData.forEach(course => {
                        const courseCard = createCourseCard(course, false, userId);
                        coursesContainer.appendChild(courseCard);
                    });
                }
                
                // Display enrolled courses
                if (enrolledCoursesData.length === 0) {
                    enrolledCoursesContainer.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-bookmark"></i>
                            <h3>No Enrolled Courses</h3>
                            <p>You haven't enrolled in any courses yet. Browse available courses and start learning!</p>
                        </div>
                    `;
                } else {
                    enrolledCoursesData.forEach(course => {
                        const enrolledCard = createCourseCard(course, true, userId);
                        enrolledCoursesContainer.appendChild(enrolledCard);
                    });
                }
                
            } catch (error) {
                console.error("Error loading student courses:", error);
                coursesContainer.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Error Loading Courses</h3>
                        <p>There was an error loading courses. Please try again later.</p>
                    </div>
                `;
            }
        }

        // Create course card
        function createCourseCard(course, isEnrolled = false, userId) {
            const card = document.createElement('div');
            card.className = 'course-card';
            
            card.innerHTML = `
                <div class="course-image">
                    <i class="fas fa-book"></i>
                </div>
                <div class="course-content">
                    <h3 class="course-title">${course.title}</h3>
                    <p class="course-description">${course.description}</p>
                    
                    <div class="course-meta">
                        ${course.duration ? `<span><i class="fas fa-clock"></i> ${course.duration} weeks</span>` : ''}
                        <span><i class="fas fa-user-graduate"></i> ${isEnrolled ? 'Enrolled' : 'Available'}</span>
                    </div>
                    
                    <button class="enroll-btn" data-course-id="${course.id}" ${isEnrolled ? 'disabled' : ''}>
                        ${isEnrolled ? '<i class="fas fa-eye"></i> View Course' : '<i class="fas fa-plus-circle"></i> Enroll Now'}
                    </button>
                </div>
            `;
            
            const actionBtn = card.querySelector('.enroll-btn');
            if (isEnrolled) {
                actionBtn.addEventListener('click', async () => {
                    await viewCourseContent(course.id, course.title, userId);
                });
            } else {
                actionBtn.addEventListener('click', async () => {
                    await enrollInCourse(userId, course.id);
                });
            }
            
            return card;
        }

        // View course content (for enrolled students)
        async function viewCourseContent(courseId, courseTitle, userId) {
            try {
                currentViewingCourseId = courseId;
                
                // Hide course list, show course detail
                studentCourseListView.classList.add('hidden');
                studentCourseDetailView.classList.remove('hidden');
                
                studentCourseContent.innerHTML = `
                    <h2 style="margin-bottom: 20px;">${courseTitle}</h2>
                    <div id="courseSubjectsContent">
                        <div class="empty-state">
                            <i class="fas fa-spinner fa-spin"></i>
                            <h3>Loading Course Content...</h3>
                            <p>Please wait while we load the course materials.</p>
                        </div>
                    </div>
                `;
                
                // Load subjects for this course
                await loadSubjectsForStudent(courseId);
                
            } catch (error) {
                console.error("Error viewing course:", error);
                showNotification("Error loading course content", "error");
            }
        }

        // Load subjects for student view - FIXED VERSION
        async function loadSubjectsForStudent(courseId) {
            try {
                debugLog(`Loading subjects for course: ${courseId}`);
                
                const subjectsSnapshot = await getDocs(collection(db, "courses", courseId, "subjects"));
                debugLog(`Found ${subjectsSnapshot.size} subjects`);
                
                const subjectsContent = document.getElementById('courseSubjectsContent');
                
                if (subjectsSnapshot.empty) {
                    subjectsContent.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-folder-open"></i>
                            <h3>No Subjects Available Yet</h3>
                            <p>The course content is being prepared. Please check back later.</p>
                        </div>
                    `;
                    return;
                }
                
                subjectsContent.innerHTML = '<h3 style="margin-bottom: 20px;">Course Subjects</h3>';
                
                const subjects = [];
                for (const subjectDoc of subjectsSnapshot.docs) {
                    const subject = { 
                        id: subjectDoc.id, 
                        ...subjectDoc.data(),
                        chapters: [] 
                    };
                    subjects.push(subject);
                    
                    const subjectCard = document.createElement('div');
                    subjectCard.className = 'subject-card';
                    subjectCard.id = `subject-${subject.id}`;
                    subjectCard.innerHTML = `
                        <div class="subject-header">
                            <h4>${subject.name}</h4>
                            <span><i class="fas fa-folder"></i></span>
                        </div>
                        <div id="chapters-${subject.id}" class="chapters-container">
                            <div class="empty-state" style="padding: 20px;">
                                <i class="fas fa-spinner fa-spin"></i>
                                <p>Loading chapters...</p>
                            </div>
                        </div>
                    `;
                    
                    subjectsContent.appendChild(subjectCard);
                    
                    // Load chapters for this subject
                    await loadChaptersForStudent(courseId, subject.id);
                }
                
            } catch (error) {
                console.error("Error loading subjects:", error);
                console.error("Error details:", error.message);
                document.getElementById('courseSubjectsContent').innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Error Loading Content</h3>
                        <p>There was an error loading course content. Please try again later.</p>
                        <p style="font-size: 0.9rem; margin-top: 10px;">Error: ${error.message}</p>
                    </div>
                `;
            }
        }

        // Load chapters for student view - FIXED VERSION
        async function loadChaptersForStudent(courseId, subjectId) {
            try {
                debugLog(`Loading chapters for subject: ${subjectId} in course: ${courseId}`);
                
                const chaptersSnapshot = await getDocs(
                    collection(db, "courses", courseId, "subjects", subjectId, "chapters")
                );
                debugLog(`Found ${chaptersSnapshot.size} chapters for subject ${subjectId}`);
                
                const chaptersContainer = document.getElementById(`chapters-${subjectId}`);
                
                if (chaptersSnapshot.empty) {
                    chaptersContainer.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: var(--gray);">
                            <i class="fas fa-file-alt"></i>
                            <p>No chapters available yet</p>
                        </div>
                    `;
                    return;
                }
                
                chaptersContainer.innerHTML = '<h5 style="margin-bottom: 15px;">Chapters</h5>';
                
                const chapters = [];
                for (const chapterDoc of chaptersSnapshot.docs) {
                    const chapter = { 
                        id: chapterDoc.id, 
                        ...chapterDoc.data(),
                        files: [] 
                    };
                    chapters.push(chapter);
                    
                    const chapterCard = document.createElement('div');
                    chapterCard.className = 'chapter-card';
                    chapterCard.id = `chapter-${subjectId}-${chapter.id}`;
                    chapterCard.innerHTML = `
                        <div class="chapter-header">
                            <h5>${chapter.name}</h5>
                        </div>
                        <div id="files-${subjectId}-${chapter.id}" class="chapter-files">
                            <div style="text-align: center; padding: 10px; color: var(--gray);">
                                <i class="fas fa-spinner fa-spin"></i>
                                <p>Loading files...</p>
                            </div>
                        </div>
                    `;
                    
                    chaptersContainer.appendChild(chapterCard);
                    
                    // Load files for this chapter
                    await loadFilesForStudent(courseId, subjectId, chapter.id);
                }
                
            } catch (error) {
                console.error("Error loading chapters:", error);
                console.error("Error details:", error.message);
                document.getElementById(`chapters-${subjectId}`).innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--gray);">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Error loading chapters</p>
                    </div>
                `;
            }
        }

        // Load files for student view - FIXED VERSION
        async function loadFilesForStudent(courseId, subjectId, chapterId) {
            try {
                debugLog(`Loading files for chapter: ${chapterId} in subject: ${subjectId}`);
                
                const filesSnapshot = await getDocs(
                    collection(db, "courses", courseId, "subjects", subjectId, "chapters", chapterId, "files")
                );
                debugLog(`Found ${filesSnapshot.size} files for chapter ${chapterId}`);
                
                const filesContainer = document.getElementById(`files-${subjectId}-${chapterId}`);
                
                if (filesSnapshot.empty) {
                    filesContainer.innerHTML = `
                        <div style="text-align: center; padding: 10px; color: var(--gray);">
                            <i class="fas fa-file"></i>
                            <p>No files uploaded yet</p>
                        </div>
                    `;
                    return;
                }
                
                filesContainer.innerHTML = '<h6 style="margin-bottom: 10px;">Files</h6>';
                
                for (const fileDoc of filesSnapshot.docs) {
                    const file = { id: fileDoc.id, ...fileDoc.data() };
                    
                    let badgeClass = '';
                    let icon = '';
                    
                    switch (file.type) {
                        case 'VOD':
                            badgeClass = 'vod-badge';
                            icon = '<i class="fas fa-video"></i>';
                            break;
                        case 'NOTES':
                            badgeClass = 'notes-badge';
                            icon = '<i class="fas fa-file-pdf"></i>';
                            break;
                        case 'MCQS':
                            badgeClass = 'mcqs-badge';
                            icon = '<i class="fas fa-question-circle"></i>';
                            break;
                        default:
                            badgeClass = 'vod-badge';
                            icon = '<i class="fas fa-file"></i>';
                    }
                    
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item';
                    fileItem.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 10px;">
                            ${icon}
                            <span>${file.name}</span>
                        </div>
                        <div>
                            <span class="file-type-badge ${badgeClass}">${file.type}</span>
                            ${file.url ? `<a href="${file.url}" target="_blank" style="margin-left: 10px; color: var(--primary);">
                                <i class="fas fa-download"></i>
                            </a>` : ''}
                        </div>
                    `;
                    
                    filesContainer.appendChild(fileItem);
                }
                
            } catch (error) {
                console.error("Error loading files:", error);
                console.error("Error details:", error.message);
                document.getElementById(`files-${subjectId}-${chapterId}`).innerHTML = `
                    <div style="text-align: center; padding: 10px; color: var(--gray);">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Error loading files</p>
                    </div>
                `;
            }
        }

        // Enroll student in a course
        async function enrollInCourse(userId, courseId) {
            try {
                debugLog(`Enrolling user ${userId} in course ${courseId}`);
                
                const userRef = doc(db, "users", userId);
                const userSnap = await getDoc(userRef);
                
                if (!userSnap.exists()) {
                    showNotification("User data not found. Please refresh and try again.", "error");
                    return;
                }
                
                const userData = userSnap.data();
                const enrolledCourses = userData.enrolledCourses || [];
                
                if (enrolledCourses.includes(courseId)) {
                    showNotification("You are already enrolled in this course!", "error");
                    return;
                }
                
                enrolledCourses.push(courseId);
                
                await updateDoc(userRef, {
                    enrolledCourses: enrolledCourses,
                    lastUpdated: serverTimestamp()
                });
                
                // Reload student courses
                loadStudentCourses(userId, enrolledCourses);
                
                showNotification("Successfully enrolled in the course!", "success");
                
            } catch (error) {
                console.error("Error enrolling in course:", error);
                showNotification("Failed to enroll in course. Please try again.", "error");
            }
        }

        // Load courses for admin view
        async function loadAdminCourses() {
            try {
                adminCoursesContainer.innerHTML = "";
                
                const coursesSnapshot = await getDocs(collection(db, "courses"));
                
                if (coursesSnapshot.empty) {
                    adminCoursesContainer.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-book-open"></i>
                            <h3>No Courses Created Yet</h3>
                            <p>You haven't created any courses yet. Use the form above to create your first course.</p>
                        </div>
                    `;
                    return;
                }
                
                coursesSnapshot.forEach((doc) => {
                    const course = { id: doc.id, ...doc.data() };
                    
                    const courseItem = document.createElement('div');
                    courseItem.className = 'admin-course-item';
                    
                    courseItem.innerHTML = `
                        <div class="admin-course-info">
                            <h4>${course.title}</h4>
                            <p>${course.description.substring(0, 100)}${course.description.length > 100 ? '...' : ''}</p>
                            <small><strong>Duration:</strong> ${course.duration || 'Not set'} weeks | 
                                   <strong>Created:</strong> ${course.createdAt ? new Date(course.createdAt.seconds * 1000).toLocaleDateString() : 'Recently'}
                            </small>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn-primary manage-course-btn" data-course-id="${doc.id}" data-course-title="${course.title}">
                                <i class="fas fa-cog"></i> Manage
                            </button>
                            <button class="btn-danger delete-course-btn" data-course-id="${doc.id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                    
                    adminCoursesContainer.appendChild(courseItem);
                });
                
                // Add event listeners to manage buttons
                document.querySelectorAll('.manage-course-btn').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const courseId = e.target.closest('.manage-course-btn').getAttribute('data-course-id');
                        const courseTitle = e.target.closest('.manage-course-btn').getAttribute('data-course-title');
                        await manageCourse(courseId, courseTitle);
                    });
                });
                
                // Add event listeners to delete buttons
                document.querySelectorAll('.delete-course-btn').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const courseId = e.target.closest('.delete-course-btn').getAttribute('data-course-id');
                        if (confirm("Are you sure you want to delete this course? This will delete all subjects, chapters and files.")) {
                            await deleteCourse(courseId);
                        }
                    });
                });
                
            } catch (error) {
                console.error("Error loading admin courses:", error);
                adminCoursesContainer.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Error Loading Courses</h3>
                        <p>There was an error loading courses. Please try again.</p>
                    </div>
                `;
            }
        }

        // Manage course (show subjects, chapters, files)
        async function manageCourse(courseId, courseTitle) {
            currentManagingCourseId = courseId;
            courseManageTitle.textContent = `Course: ${courseTitle}`;
            
            adminCourseListView.classList.add('hidden');
            courseManageView.classList.remove('hidden');
            
            await loadSubjectsForAdmin(courseId);
        }

        // Load subjects for admin
        async function loadSubjectsForAdmin(courseId) {
            try {
                subjectsContainer.innerHTML = '<h4 style="margin-bottom: 20px;">Subjects</h4>';
                
                const subjectsSnapshot = await getDocs(collection(db, "courses", courseId, "subjects"));
                
                if (subjectsSnapshot.empty) {
                    subjectsContainer.innerHTML += `
                        <div class="empty-state">
                            <i class="fas fa-folder-open"></i>
                            <h3>No Subjects Yet</h3>
                            <p>Add your first subject to start organizing course content.</p>
                        </div>
                    `;
                    return;
                }
                
                for (const subjectDoc of subjectsSnapshot.docs) {
                    const subject = { id: subjectDoc.id, ...subjectDoc.data() };
                    
                    const subjectCard = document.createElement('div');
                    subjectCard.className = 'subject-card';
                    subjectCard.innerHTML = `
                        <div class="subject-header">
                            <h4>${subject.name}</h4>
                            <div>
                                <button class="btn-primary add-chapter-btn" data-subject-id="${subject.id}" style="padding: 5px 10px; margin-right: 5px;">
                                    <i class="fas fa-plus"></i> Add Chapter
                                </button>
                                <button class="btn-danger delete-subject-btn" data-subject-id="${subject.id}" style="padding: 5px 10px;">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div id="chapters-admin-${subject.id}" class="chapters-container">
                            <div style="text-align: center; padding: 20px; color: var(--gray);">
                                <i class="fas fa-spinner fa-spin"></i>
                                <p>Loading chapters...</p>
                            </div>
                        </div>
                    `;
                    
                    subjectsContainer.appendChild(subjectCard);
                    
                    // Load chapters for this subject
                    await loadChaptersForAdmin(courseId, subject.id);
                }
                
                // Add event listeners
                document.querySelectorAll('.add-chapter-btn').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const subjectId = e.target.closest('.add-chapter-btn').getAttribute('data-subject-id');
                        const chapterName = prompt("Enter chapter name:");
                        if (chapterName && chapterName.trim()) {
                            await addChapter(courseId, subjectId, chapterName.trim());
                        }
                    });
                });
                
                document.querySelectorAll('.delete-subject-btn').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const subjectId = e.target.closest('.delete-subject-btn').getAttribute('data-subject-id');
                        if (confirm("Delete this subject and all its chapters and files?")) {
                            await deleteSubject(courseId, subjectId);
                        }
                    });
                });
                
            } catch (error) {
                console.error("Error loading subjects:", error);
                subjectsContainer.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Error Loading Subjects</h3>
                        <p>There was an error loading subjects. Please try again.</p>
                    </div>
                `;
            }
        }

        // Load chapters for admin
        async function loadChaptersForAdmin(courseId, subjectId) {
            try {
                const chaptersSnapshot = await getDocs(collection(db, "courses", courseId, "subjects", subjectId, "chapters"));
                
                const chaptersContainer = document.getElementById(`chapters-admin-${subjectId}`);
                
                if (chaptersSnapshot.empty) {
                    chaptersContainer.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: var(--gray);">
                            <i class="fas fa-file-alt"></i>
                            <p>No chapters yet. Add a chapter to start uploading files.</p>
                        </div>
                    `;
                    return;
                }
                
                chaptersContainer.innerHTML = '<h5>Chapters</h5>';
                
                for (const chapterDoc of chaptersSnapshot.docs) {
                    const chapter = { id: chapterDoc.id, ...chapterDoc.data() };
                    
                    const chapterCard = document.createElement('div');
                    chapterCard.className = 'chapter-card';
                    chapterCard.innerHTML = `
                        <div class="chapter-header">
                            <h5>${chapter.name}</h5>
                            <div>
                                <div class="upload-controls">
                                    <select class="file-type-select" id="file-type-${subjectId}-${chapter.id}">
                                        <option value="VOD">VOD (Video)</option>
                                        <option value="NOTES">NOTES (PDF/Document)</option>
                                        <option value="MCQS">MCQS (Questions)</option>
                                    </select>
                                    <input type="file" id="file-upload-${subjectId}-${chapter.id}" class="hidden">
                                    <button class="btn-primary upload-file-btn" data-subject-id="${subjectId}" data-chapter-id="${chapter.id}" style="padding: 5px 10px;">
                                        <i class="fas fa-upload"></i> Upload File
                                    </button>
                                </div>
                                <button class="btn-danger delete-chapter-btn" data-subject-id="${subjectId}" data-chapter-id="${chapter.id}" style="padding: 5px 10px; margin-top: 5px;">
                                    <i class="fas fa-trash"></i> Delete Chapter
                                </button>
                            </div>
                        </div>
                        <div id="files-admin-${subjectId}-${chapter.id}" class="chapter-files">
                            <div style="text-align: center; padding: 10px; color: var(--gray);">
                                <i class="fas fa-spinner fa-spin"></i>
                                <p>Loading files...</p>
                            </div>
                        </div>
                    `;
                    
                    chaptersContainer.appendChild(chapterCard);
                    
                    // Load files for this chapter
                    await loadFilesForAdmin(courseId, subjectId, chapter.id);
                }
                
                // Add event listeners for file upload
                document.querySelectorAll('.upload-file-btn').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const subjectId = e.target.closest('.upload-file-btn').getAttribute('data-subject-id');
                        const chapterId = e.target.closest('.upload-file-btn').getAttribute('data-chapter-id');
                        
                        const fileTypeSelect = document.getElementById(`file-type-${subjectId}-${chapterId}`);
                        const fileType = fileTypeSelect ? fileTypeSelect.value : 'VOD';
                        
                        const fileInput = document.getElementById(`file-upload-${subjectId}-${chapterId}`);
                        if (fileInput) {
                            fileInput.click();
                            fileInput.onchange = async (event) => {
                                if (event.target.files[0]) {
                                    await uploadFile(courseId, subjectId, chapterId, event.target.files[0], fileType);
                                }
                            };
                        }
                    });
                });
                
                // Add event listeners for delete chapter
                document.querySelectorAll('.delete-chapter-btn').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const subjectId = e.target.closest('.delete-chapter-btn').getAttribute('data-subject-id');
                        const chapterId = e.target.closest('.delete-chapter-btn').getAttribute('data-chapter-id');
                        if (confirm("Delete this chapter and all its files?")) {
                            await deleteChapter(courseId, subjectId, chapterId);
                        }
                    });
                });
                
            } catch (error) {
                console.error("Error loading chapters:", error);
                document.getElementById(`chapters-admin-${subjectId}`).innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--gray);">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Error loading chapters</p>
                    </div>
                `;
            }
        }

        // Load files for admin
        async function loadFilesForAdmin(courseId, subjectId, chapterId) {
            try {
                const filesSnapshot = await getDocs(collection(db, "courses", courseId, "subjects", subjectId, "chapters", chapterId, "files"));
                
                const filesContainer = document.getElementById(`files-admin-${subjectId}-${chapterId}`);
                
                if (filesSnapshot.empty) {
                    filesContainer.innerHTML = `
                        <div style="text-align: center; padding: 10px; color: var(--gray);">
                            <i class="fas fa-file"></i>
                            <p>No files uploaded yet</p>
                        </div>
                    `;
                    return;
                }
                
                filesContainer.innerHTML = '<h6 style="margin-bottom: 10px;">Files</h6>';
                
                for (const fileDoc of filesSnapshot.docs) {
                    const file = { id: fileDoc.id, ...fileDoc.data() };
                    
                    let badgeClass = '';
                    let icon = '';
                    
                    switch (file.type) {
                        case 'VOD':
                            badgeClass = 'vod-badge';
                            icon = '<i class="fas fa-video"></i>';
                            break;
                        case 'NOTES':
                            badgeClass = 'notes-badge';
                            icon = '<i class="fas fa-file-pdf"></i>';
                            break;
                        case 'MCQS':
                            badgeClass = 'mcqs-badge';
                            icon = '<i class="fas fa-question-circle"></i>';
                            break;
                        default:
                            badgeClass = 'vod-badge';
                            icon = '<i class="fas fa-file"></i>';
                    }
                    
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item';
                    fileItem.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 10px;">
                            ${icon}
                            <span>${file.name}</span>
                        </div>
                        <div class="file-actions">
                            <span class="file-type-badge ${badgeClass}">${file.type}</span>
                            <a href="${file.url}" target="_blank" style="color: var(--primary); margin: 0 10px;">
                                <i class="fas fa-download"></i>
                            </a>
                            <button class="btn-danger delete-file-btn" data-file-id="${fileDoc.id}" data-subject-id="${subjectId}" data-chapter-id="${chapterId}" style="padding: 3px 8px; font-size: 0.8rem;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                    
                    filesContainer.appendChild(fileItem);
                }
                
                // Add event listeners for delete file
                document.querySelectorAll('.delete-file-btn').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const fileId = e.target.closest('.delete-file-btn').getAttribute('data-file-id');
                        const subjectId = e.target.closest('.delete-file-btn').getAttribute('data-subject-id');
                        const chapterId = e.target.closest('.delete-file-btn').getAttribute('data-chapter-id');
                        if (confirm("Delete this file?")) {
                            await deleteFile(courseId, subjectId, chapterId, fileId);
                        }
                    });
                });
                
            } catch (error) {
                console.error("Error loading files:", error);
                document.getElementById(`files-admin-${subjectId}-${chapterId}`).innerHTML = `
                    <div style="text-align: center; padding: 10px; color: var(--gray);">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Error loading files</p>
                    </div>
                `;
            }
        }

        // Add chapter
        async function addChapter(courseId, subjectId, chapterName) {
            try {
                await addDoc(collection(db, "courses", courseId, "subjects", subjectId, "chapters"), {
                    name: chapterName,
                    createdAt: serverTimestamp(),
                    order: 0
                });
                
                loadChaptersForAdmin(courseId, subjectId);
                showNotification("Chapter added successfully!", "success");
                
            } catch (error) {
                console.error("Error adding chapter:", error);
                showNotification("Failed to add chapter", "error");
            }
        }

        // Upload file
        async function uploadFile(courseId, subjectId, chapterId, file, type) {
            try {
                if (!file) return;
                
                // Create storage reference
                const storageRef = ref(storage, `courses/${courseId}/${subjectId}/${chapterId}/${Date.now()}_${file.name}`);
                
                // Upload file
                const snapshot = await uploadBytes(storageRef, file);
                const downloadURL = await getDownloadURL(snapshot.ref);
                
                // Save file info to Firestore
                await addDoc(collection(db, "courses", courseId, "subjects", subjectId, "chapters", chapterId, "files"), {
                    name: file.name,
                    type: type,
                    url: downloadURL,
                    size: file.size,
                    uploadedAt: serverTimestamp()
                });
                
                // Reload files
                loadFilesForAdmin(courseId, subjectId, chapterId);
                showNotification("File uploaded successfully!", "success");
                
            } catch (error) {
                console.error("Error uploading file:", error);
                showNotification("Failed to upload file", "error");
            }
        }

        // Delete subject
        async function deleteSubject(courseId, subjectId) {
            try {
                // First delete all chapters in this subject
                const chaptersSnapshot = await getDocs(collection(db, "courses", courseId, "subjects", subjectId, "chapters"));
                
                for (const chapterDoc of chaptersSnapshot.docs) {
                    await deleteChapter(courseId, subjectId, chapterDoc.id);
                }
                
                // Then delete the subject
                await deleteDoc(doc(db, "courses", courseId, "subjects", subjectId));
                
                loadSubjectsForAdmin(courseId);
                showNotification("Subject deleted successfully!", "success");
                
            } catch (error) {
                console.error("Error deleting subject:", error);
                showNotification("Failed to delete subject", "error");
            }
        }

        // Delete chapter
        async function deleteChapter(courseId, subjectId, chapterId) {
            try {
                // First delete all files in this chapter
                const filesSnapshot = await getDocs(collection(db, "courses", courseId, "subjects", subjectId, "chapters", chapterId, "files"));
                
                for (const fileDoc of filesSnapshot.docs) {
                    await deleteDoc(doc(db, "courses", courseId, "subjects", subjectId, "chapters", chapterId, "files", fileDoc.id));
                }
                
                // Then delete the chapter
                await deleteDoc(doc(db, "courses", courseId, "subjects", subjectId, "chapters", chapterId));
                
                loadChaptersForAdmin(courseId, subjectId);
                showNotification("Chapter deleted successfully!", "success");
                
            } catch (error) {
                console.error("Error deleting chapter:", error);
                showNotification("Failed to delete chapter", "error");
            }
        }

        // Delete file
        async function deleteFile(courseId, subjectId, chapterId, fileId) {
            try {
                await deleteDoc(doc(db, "courses", courseId, "subjects", subjectId, "chapters", chapterId, "files", fileId));
                
                loadFilesForAdmin(courseId, subjectId, chapterId);
                showNotification("File deleted successfully!", "success");
                
            } catch (error) {
                console.error("Error deleting file:", error);
                showNotification("Failed to delete file", "error");
            }
        }

        // Load students list for admin
        async function loadStudentsList() {
            try {
                console.log("Loading students list with details...");
                studentsTable.innerHTML = `
                    <div class="table-header">
                        <div>#</div>
                        <div>Student Name</div>
                        <div>Contact Info</div>
                        <div>Personal Details</div>
                        <div>Courses</div>
                        <div>Joined</div>
                    </div>
                `;
                
                const usersSnapshot = await getDocs(collection(db, "users"));
                const coursesSnapshot = await getDocs(collection(db, "courses"));
                
                console.log("Total users in Firestore:", usersSnapshot.size);
                
                // Create course map
                const courseMap = {};
                coursesSnapshot.forEach(doc => {
                    courseMap[doc.id] = doc.data().title;
                });
                
                let studentNumber = 1;
                let hasStudents = false;
                
                usersSnapshot.forEach((doc) => {
                    const userData = doc.data();
                    console.log("Checking user:", userData.email, "Role:", userData.role);
                    
                    // Skip admin users
                    if (userData.email === ADMIN_EMAIL || userData.role === "admin") {
                        console.log("Skipping admin user:", userData.email);
                        return;
                    }
                    
                    hasStudents = true;
                    const enrolledCourses = userData.enrolledCourses || [];
                    const enrolledCourseNames = enrolledCourses.map(id => courseMap[id] || "Unknown Course");
                    
                    const row = document.createElement('div');
                    row.className = 'table-row';
                    
                    // Format date of birth
                    const dobFormatted = userData.dob ? 
                        new Date(userData.dob).toLocaleDateString() : 
                        "Not set";
                    
                    // Format join date
                    const joinDateFormatted = userData.createdAt ? 
                        new Date(userData.createdAt.seconds * 1000).toLocaleDateString() : 
                        "Recently";
                    
                    row.innerHTML = `
                        <div>${studentNumber++}</div>
                        <div>
                            <strong>${userData.fullName || userData.displayName || "Anonymous User"}</strong><br>
                            <small>${userData.email}</small>
                        </div>
                        <div>
                            <div><strong>Phone:</strong> ${userData.phone || "Not set"}</div>
                            <div><strong>Address:</strong> ${userData.address ? userData.address.substring(0, 50) + (userData.address.length > 50 ? '...' : '') : "Not set"}</div>
                        </div>
                        <div>
                            <div><strong>DOB:</strong> ${dobFormatted}</div>
                            <div><strong>Gender:</strong> ${userData.gender || "Not set"}</div>
                            <div><strong>Education:</strong> ${userData.education || "Not set"}</div>
                        </div>
                        <div>
                            <span class="enrolled-courses-count">${enrolledCourses.length} courses</span>
                            ${enrolledCourseNames.length > 0 ? 
                                `<div style="margin-top: 5px; font-size: 0.85rem; color: var(--gray);">
                                    ${enrolledCourseNames.slice(0, 2).join(', ')}
                                    ${enrolledCourseNames.length > 2 ? ` +${enrolledCourseNames.length - 2} more` : ''}
                                </div>` : 
                                '<div style="font-size: 0.85rem; color: var(--gray);">Not enrolled yet</div>'
                            }
                        </div>
                        <div>
                            ${joinDateFormatted}<br>
                            <small style="color: var(--gray);">${userData.profileCompleted ? 'Profile ' : 'Incomplete'}</small>
                        </div>
                    `;
                    
                    studentsTable.appendChild(row);
                });
                
                if (!hasStudents) {
                    studentsTable.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-users"></i>
                            <h3>No Students Yet</h3>
                            <p>No students have signed up for the platform yet.</p>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error("Error loading students list:", error);
                studentsTable.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Error Loading Students</h3>
                        <p>There was an error loading the students list. Please try again.</p>
                    </div>
                `;
            }
        }

        // Create new course (admin only)
        createCourseForm?.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const title = document.getElementById('courseTitle').value.trim();
            const description = document.getElementById('courseDescription').value.trim();
            const duration = document.getElementById('courseDuration').value;
            
            if (!title || !description) {
                showNotification("Please fill in all required fields.", "error");
                return;
            }
            
            try {
                // Add course to Firestore
                await addDoc(collection(db, "courses"), {
                    title: title,
                    description: description,
                    duration: duration ? parseInt(duration) : null,
                    createdAt: serverTimestamp(),
                    createdBy: ADMIN_EMAIL
                });
                
                // Reset form
                createCourseForm.reset();
                
                // Reload everything
                loadAdminCourses();
                loadAllCourses();
                
                showNotification("Course created successfully! Students can now see and enroll in it.", "success");
                
            } catch (error) {
                console.error("Error creating course:", error);
                showNotification("Failed to create course. Please try again.", "error");
            }
        });

        // Delete course
        async function deleteCourse(courseId) {
            try {
                // First delete all subjects (which will delete chapters and files)
                const subjectsSnapshot = await getDocs(collection(db, "courses", courseId, "subjects"));
                
                for (const subjectDoc of subjectsSnapshot.docs) {
                    await deleteSubject(courseId, subjectDoc.id);
                }
                
                // Then delete the course
                await deleteDoc(doc(db, "courses", courseId));
                
                // Remove from users' enrolled courses
                const usersSnapshot = await getDocs(collection(db, "users"));
                
                for (const userDoc of usersSnapshot.docs) {
                    const userData = userDoc.data();
                    if (userData.enrolledCourses && userData.enrolledCourses.includes(courseId)) {
                        const updatedCourses = userData.enrolledCourses.filter(id => id !== courseId);
                        await updateDoc(doc(db, "users", userDoc.id), {
                            enrolledCourses: updatedCourses
                        });
                    }
                }
                
                loadAdminCourses();
                loadAllCourses();
                
                showNotification("Course deleted successfully!", "success");
                
            } catch (error) {
                console.error("Error deleting course:", error);
                showNotification("Failed to delete course. Please try again.", "error");
            }
        }

        // Show notification
        function showNotification(message, type = "info") {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 8px;
                color: white;
                font-weight: 600;
                z-index: 1000;
                box-shadow: 0 5px 15px rgba(0,0,0,0.2);
                animation: slideIn 0.3s ease;
            `;
            
            if (type === "success") {
                notification.style.backgroundColor = "#10b981";
            } else if (type === "error") {
                notification.style.backgroundColor = "#ef4444";
            } else {
                notification.style.backgroundColor = "#3b82f6";
            }
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = "slideOut 0.3s ease";
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // Add CSS for notifications
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
